

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Approximate Bayesian Computation &#8212; Think Bayes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap20';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The Red Line Problem" href="redline.html" />
    <link rel="prev" title="MCMC" href="chap19.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    <p class="title logo__title">Think Bayes</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Think Bayes 2
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap01.html">Probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">Bayes’s Theorem</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">Estimating Proportions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">Estimating Counts</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">Odds and Addends</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">Minimum, Maximum, and Mixture</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">Poisson Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">Decision Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap11.html">Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap13.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">Survival Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap15.html">Mark and Recapture</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap16.html">Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap17.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap18.html">Conjugate Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap19.html">MCMC</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Approximate Bayesian Computation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="redline.html">The Red Line Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="vaccine2.html">Estimating vaccine efficacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="usb.html">Flipping USB Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="sister.html">The Left Handed Sister Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes_dice.html">Bayesian Dice</a></li>
<li class="toctree-l1"><a class="reference internal" href="radiation.html">The Emitter-Detector Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="hospital.html">Grid algorithms for hierarchical models</a></li>
<li class="toctree-l1"><a class="reference internal" href="hospital_birth_rate.html">Comparing birth rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="ok.html">How Many Typos?</a></li>
<li class="toctree-l1"><a class="reference internal" href="bookstore.html">How Many Books?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ThinkBayes2" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap20.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Approximate Bayesian Computation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-kidney-tumor-problem">The Kidney Tumor Problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-growth-model">A Simple Growth Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-more-general-model">A More General Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approximate-bayesian-calculation">Approximate Bayesian Calculation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#counting-cells">Counting Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cell-counting-with-abc">Cell Counting with ABC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-do-we-get-to-the-approximate-part">When Do We Get to the Approximate Part?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="approximate-bayesian-computation">
<h1>Approximate Bayesian Computation<a class="headerlink" href="#approximate-bayesian-computation" title="Permalink to this heading">#</a></h1>
<p>This chapter introduces a method of last resort for the most complex problems, Approximate Bayesian Computation (ABC).
I say it is a last resort because it usually requires more computation than other methods, so if you can solve a problem any other way, you should.
However, for the examples in this chapter, ABC is not just easy to implement; it is also efficient.</p>
<p>The first example is my solution to a problem posed by a patient
with a kidney tumor.
I use data from a medical journal to model tumor growth, and use simulations to estimate the age of a tumor based on its size.</p>
<p>The second example is a model of cell counting, which has applications in biology, medicine, and zymurgy (beer-making).
Given a cell count from a diluted sample, we estimate the concentration of cells.</p>
<p>Finally, as an exercise, you’ll have a chance to work on a fun sock-counting problem.</p>
<section id="the-kidney-tumor-problem">
<h2>The Kidney Tumor Problem<a class="headerlink" href="#the-kidney-tumor-problem" title="Permalink to this heading">#</a></h2>
<p>I am a frequent reader and occasional contributor to the online
statistics forum at <a class="reference external" href="http://reddit.com/r/statistics">http://reddit.com/r/statistics</a>.
In November 2011, I read the following message:</p>
<blockquote>
<div><p>“I have Stage IV Kidney Cancer and am trying to determine if the cancer formed before I retired from the military. … Given the dates of retirement and detection is it possible to determine when there was a 50/50 chance that I developed the disease? Is it possible to determine the probability on the retirement date? My tumor was 15.5 cm x 15 cm at detection. Grade II.”</p>
</div></blockquote>
<p>I contacted the author of the message to get more information; I
learned that veterans get different benefits if it is “more likely than not” that a tumor formed while they were in military service (among other considerations).
So I agree to help him answer his question.</p>
<p>Because renal tumors grow slowly, and often do not cause symptoms, they are sometimes left untreated. As a result, doctors can observe the rate of growth for untreated tumors by comparing scans from the same patient at different times. Several papers have reported these growth rates.</p>
<p>For my analysis I used data from a paper by <a class="reference external" href="https://pubs.rsna.org/doi/full/10.1148/radiol.2501071712">Zhang et al</a>.
They report growth rates in two forms:</p>
<ul class="simple">
<li><p>Volumetric doubling time, which is the time it would take for a tumor to double in size.</p></li>
<li><p>Reciprocal doubling time (RDT), which is the number of doublings per year.</p></li>
</ul>
<p>The next section shows how we work with these growth rates.</p>
<p>Zhang et al, Distribution of Renal Tumor Growth Rates Determined
by Using Serial Volumetric CT Measurements, January 2009
<em>Radiology</em>, 250, 137-144.</p>
<p><a class="reference external" href="https://pubs.rsna.org/doi/full/10.1148/radiol.2501071712">https://pubs.rsna.org/doi/full/10.1148/radiol.2501071712</a></p>
</section>
<section id="a-simple-growth-model">
<h2>A Simple Growth Model<a class="headerlink" href="#a-simple-growth-model" title="Permalink to this heading">#</a></h2>
<p>We’ll start with a simple model of tumor growth based on two assumptions:</p>
<ul class="simple">
<li><p>Tumors grow with a constant doubling time, and</p></li>
<li><p>They are roughly spherical in shape.</p></li>
</ul>
<p>And I’ll define two points in time:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">t1</span></code> is when my correspondent retired.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">t2</span></code> is when the tumor was detected.</p></li>
</ul>
<p>The time between <code class="docutils literal notranslate"><span class="pre">t1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code> was about 9.0 years.
As an example, let’s assume that the diameter of the tumor was 1 cm at <code class="docutils literal notranslate"><span class="pre">t1</span></code>, and estimate its size at <code class="docutils literal notranslate"><span class="pre">t2</span></code>.</p>
<p>I’ll use the following function to compute the volume of a sphere with a given diameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">calc_volume</span><span class="p">(</span><span class="n">diameter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a diameter to a volume.&quot;&quot;&quot;</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">diameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<p>Assuming that the tumor is spherical, we can compute its volume at <code class="docutils literal notranslate"><span class="pre">t1</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">calc_volume</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
<span class="n">v1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5235987755982988
</pre></div>
</div>
</div>
</div>
<p>The median volume doubling time reported by Zhang et al. is 811 days, which corresponds to an RDT of 0.45 doublings per year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">median_doubling_time</span> <span class="o">=</span> <span class="mi">811</span>
<span class="n">rdt</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">/</span> <span class="n">median_doubling_time</span>
<span class="n">rdt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.45006165228113443
</pre></div>
</div>
</div>
</div>
<p>We can compute the number of doublings that would have happened in the interval between <code class="docutils literal notranslate"><span class="pre">t1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span> <span class="o">=</span> <span class="mf">9.0</span>
<span class="n">doublings</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">rdt</span>
<span class="n">doublings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.05055487053021
</pre></div>
</div>
</div>
</div>
<p>Given <code class="docutils literal notranslate"><span class="pre">v1</span></code> and the number of doublings, we can compute the volume at <code class="docutils literal notranslate"><span class="pre">t2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">doublings</span>
<span class="n">v2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.676351488087187
</pre></div>
</div>
</div>
</div>
<p>The following function computes the diameter of a sphere with the given volume.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_diameter</span><span class="p">(</span><span class="n">volume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a volume to a diameter.&quot;&quot;&quot;</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>So we can compute the diameter of the tumor at <code class="docutils literal notranslate"><span class="pre">t2</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d2</span> <span class="o">=</span> <span class="n">calc_diameter</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
<span class="n">d2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.5494480788327483
</pre></div>
</div>
</div>
</div>
<p>If the diameter of the tumor was 1 cm at <code class="docutils literal notranslate"><span class="pre">t1</span></code>, and it grew at the median rate, the diameter would be about 2.5 cm at <code class="docutils literal notranslate"><span class="pre">t2</span></code>.</p>
<p>This example demonstrates the growth model, but it doesn’t answer the question my correspondent posed.</p>
</section>
<section id="a-more-general-model">
<h2>A More General Model<a class="headerlink" href="#a-more-general-model" title="Permalink to this heading">#</a></h2>
<p>Given the size of a tumor at time of diagnosis, we would like to know the distribution of its age.
To find it, we’ll run simulations of tumor growth to get the distribution of size conditioned on age.
Then we’ll compute the distribution of age conditioned on size.</p>
<p>The simulation starts with a small tumor and runs these steps:</p>
<ol class="arabic simple">
<li><p>Choose a value from the distribution of growth rates.</p></li>
<li><p>Compute the size of the tumor at the end of an interval.</p></li>
<li><p>Repeat until the tumor exceeds the maximum relevant size.</p></li>
</ol>
<p>So the first thing we need is the distribution of growth rates.</p>
<p>Using the figures in the paper by Zhange et al., I created an array, <code class="docutils literal notranslate"><span class="pre">rdt_sample</span></code>, that contains estimated values of RDT for the 53 patients in the study.</p>
<p>Again, RDT stands for “reciprocal doubling time”, which is in doublings per year.
So if <code class="docutils literal notranslate"><span class="pre">rdt=1</span></code>, a tumor would double in volume in one year.
If <code class="docutils literal notranslate"><span class="pre">rdt=2</span></code>, it would double twice; that is, the volume would quadruple.
And if <code class="docutils literal notranslate"><span class="pre">rdt=-1</span></code>, it would halve in volume.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data from the scatter plot in Figure 4</span>

<span class="n">rdts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.089</span><span class="p">,</span>  <span class="mf">3.572</span><span class="p">,</span>  <span class="mf">3.242</span><span class="p">,</span>  <span class="mf">2.642</span><span class="p">,</span>  <span class="mf">1.982</span><span class="p">,</span>  <span class="mf">1.847</span><span class="p">,</span>  <span class="mf">1.908</span><span class="p">,</span>  <span class="mf">1.798</span><span class="p">,</span>
        <span class="mf">1.798</span><span class="p">,</span>  <span class="mf">1.761</span><span class="p">,</span>  <span class="mf">2.703</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.416</span><span class="p">,</span>  <span class="mf">0.024</span><span class="p">,</span>  <span class="mf">0.869</span><span class="p">,</span>  <span class="mf">0.746</span><span class="p">,</span>  <span class="mf">0.257</span><span class="p">,</span>
        <span class="mf">0.269</span><span class="p">,</span>  <span class="mf">0.086</span><span class="p">,</span>  <span class="mf">0.086</span><span class="p">,</span>  <span class="mf">1.321</span><span class="p">,</span>  <span class="mf">1.052</span><span class="p">,</span>  <span class="mf">1.076</span><span class="p">,</span>  <span class="mf">0.758</span><span class="p">,</span>  <span class="mf">0.587</span><span class="p">,</span>
        <span class="mf">0.367</span><span class="p">,</span>  <span class="mf">0.416</span><span class="p">,</span>  <span class="mf">0.073</span><span class="p">,</span>  <span class="mf">0.538</span><span class="p">,</span>  <span class="mf">0.281</span><span class="p">,</span>  <span class="mf">0.122</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.869</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.431</span><span class="p">,</span>
        <span class="mf">0.012</span><span class="p">,</span>  <span class="mf">0.037</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.135</span><span class="p">,</span>  <span class="mf">0.122</span><span class="p">,</span>  <span class="mf">0.208</span><span class="p">,</span>  <span class="mf">0.245</span><span class="p">,</span>  <span class="mf">0.404</span><span class="p">,</span>  <span class="mf">0.648</span><span class="p">,</span>
        <span class="mf">0.673</span><span class="p">,</span>  <span class="mf">0.673</span><span class="p">,</span>  <span class="mf">0.563</span><span class="p">,</span>  <span class="mf">0.391</span><span class="p">,</span>  <span class="mf">0.049</span><span class="p">,</span>  <span class="mf">0.538</span><span class="p">,</span>  <span class="mf">0.514</span><span class="p">,</span>  <span class="mf">0.404</span><span class="p">,</span>
        <span class="mf">0.404</span><span class="p">,</span>  <span class="mf">0.33</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.061</span><span class="p">,</span>  <span class="mf">0.538</span><span class="p">,</span>  <span class="mf">0.306</span><span class="p">]</span>

<span class="n">rdt_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rdts</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">rdt_sample</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>53
</pre></div>
</div>
</div>
</details>
</div>
<p>We can use the sample of RDTs to estimate the PDF of the distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">kde_from_sample</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
<span class="n">pmf_rdt</span> <span class="o">=</span> <span class="n">kde_from_sample</span><span class="p">(</span><span class="n">rdt_sample</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what it looks like.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">decorate</span>

<span class="n">pmf_rdt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;rdts&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Reciprocal doubling time (RDT)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Distribution of growth rates&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/914a6146b4348099a8272fb971569ca6c637ea221de92d28038e20285408c1bd.png" src="_images/914a6146b4348099a8272fb971569ca6c637ea221de92d28038e20285408c1bd.png" />
</div>
</div>
<p>In the next section we will use this distribution to simulate tumor growth.</p>
</section>
<section id="simulation">
<h2>Simulation<a class="headerlink" href="#simulation" title="Permalink to this heading">#</a></h2>
<p>Now we’re ready to run the simulations.
Starting with a small tumor, we’ll simulate a series of intervals until the tumor reaches a maximum size.</p>
<p>At the beginning of each simulated interval, we’ll choose a value from the distribution of growth rates and compute the size of the tumor at the end.</p>
<p>I chose an interval of 245 days (about 8 months) because that is the
median time between measurements in the data source</p>
<p>For the initial diameter I chose 0.3 cm, because carcinomas smaller than that are less likely to be invasive and less likely to have the blood supply needed for rapid growth (see <a class="reference external" href="http://en.wikipedia.org/wiki/Carcinoma_in_situ">this page on carcinoma</a>).
For the maximum diameter I chose 20 cm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span> <span class="o">=</span> <span class="mi">245</span> <span class="o">/</span> <span class="mi">365</span>      <span class="c1"># year</span>
<span class="n">min_diameter</span> <span class="o">=</span> <span class="mf">0.3</span>        <span class="c1"># cm</span>
<span class="n">max_diameter</span> <span class="o">=</span> <span class="mi">20</span>         <span class="c1"># cm</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll use <code class="docutils literal notranslate"><span class="pre">calc_volume</span></code> to compute the initial and maximum volumes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v0</span> <span class="o">=</span> <span class="n">calc_volume</span><span class="p">(</span><span class="n">min_diameter</span><span class="p">)</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">calc_volume</span><span class="p">(</span><span class="n">max_diameter</span><span class="p">)</span>
<span class="n">v0</span><span class="p">,</span> <span class="n">vmax</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.014137166941154066, 4188.790204786391)
</pre></div>
</div>
</div>
</div>
<p>The following function runs the simulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">simulate_growth</span><span class="p">(</span><span class="n">pmf_rdt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate the growth of a tumor.&quot;&quot;&quot;</span>
    <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">v0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">age</span><span class="p">,</span> <span class="n">volume</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">rdt</span> <span class="o">=</span> <span class="n">pmf_rdt</span><span class="o">.</span><span class="n">choice</span><span class="p">()</span>
        <span class="n">age</span> <span class="o">+=</span> <span class="n">interval</span> 
        <span class="n">doublings</span> <span class="o">=</span> <span class="n">rdt</span> <span class="o">*</span> <span class="n">interval</span>
        <span class="n">volume</span> <span class="o">*=</span> <span class="mi">2</span><span class="o">**</span><span class="n">doublings</span>
        
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_diameter</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sim</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">simulate_growth</span></code> takes as a parameter a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> that represents the distribution of RDT.
It initializes the age and volume of the tumor, then runs a loop that simulates one interval at a time.</p>
<p>Each time through the loop, it checks the volume of the tumor and exits if it exceeds <code class="docutils literal notranslate"><span class="pre">vmax</span></code>.</p>
<p>Otherwise it chooses a value from <code class="docutils literal notranslate"><span class="pre">pmf_rdt</span></code> and updates <code class="docutils literal notranslate"><span class="pre">age</span></code> and <code class="docutils literal notranslate"><span class="pre">volume</span></code>.  Since <code class="docutils literal notranslate"><span class="pre">rdt</span></code> is in doublings per year, we multiply by <code class="docutils literal notranslate"><span class="pre">interval</span></code> to compute the number of doublings during each interval.</p>
<p>At the end of the loop, <code class="docutils literal notranslate"><span class="pre">simulate_growth</span></code> puts the results in a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and computes the diameter that corresponds to each volume.</p>
<p>Here’s how we call this function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">simulate_growth</span><span class="p">(</span><span class="n">pmf_rdt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the results for the first few intervals:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>volume</th>
      <th>diameter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000000</td>
      <td>0.014137</td>
      <td>0.300000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.671233</td>
      <td>0.014949</td>
      <td>0.305635</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.342466</td>
      <td>0.019763</td>
      <td>0.335441</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>And the last few intervals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>volume</th>
      <th>diameter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>43</th>
      <td>28.863014</td>
      <td>1882.067427</td>
      <td>15.318357</td>
    </tr>
    <tr>
      <th>44</th>
      <td>29.534247</td>
      <td>2887.563277</td>
      <td>17.667603</td>
    </tr>
    <tr>
      <th>45</th>
      <td>30.205479</td>
      <td>4953.618273</td>
      <td>21.149883</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To show the results graphically, I’ll run 101 simulations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">simulate_growth</span><span class="p">(</span><span class="n">pmf_rdt</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>And plot the results.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">diameters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
<span class="k">for</span> <span class="n">diameter</span> <span class="ow">in</span> <span class="n">diameters</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Tumor age (years)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Diameter (cm, log scale)&#39;</span><span class="p">,</span>
         <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
         <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">yticks</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/c7a36f14efef9fb97b73fc9d6d8d623e3d53b61e750e4ca983a63eb4eb7a227c.png" src="_images/c7a36f14efef9fb97b73fc9d6d8d623e3d53b61e750e4ca983a63eb4eb7a227c.png" />
</div>
</div>
<p>In this figure, each thin, solid line shows the simulated growth of a tumor over time, with diameter on a log scale.
The dotted lines are at 4, 8, and 16 cm.</p>
<p>By reading across the dotted lines, you can get a sense of the distribution of age at each size.
For example, reading across the top line, we see that the age of a 16 cm tumor might be as low 10 years or as high as 40 years, but it is most likely to be between 15 and 30.</p>
<p>To compute this distribution more precisely, we can interpolate the growth curves to see when each one passes through a given size.
The following function takes the results of the simulations and returns the age when each tumor reached a given diameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="k">def</span> <span class="nf">interpolate_ages</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">diameter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the age when each tumor reached a given size.&quot;&quot;&quot;</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">:</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">])</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">diameter</span><span class="p">)</span>
        <span class="n">ages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">age</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ages</span>
</pre></div>
</div>
</div>
</div>
<p>We can call this function like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Cdf</span>

<span class="n">ages</span> <span class="o">=</span> <span class="n">interpolate_ages</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">cdf</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">cdf</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22.31854530374061 [13.47056554 34.49632276]
</pre></div>
</div>
</div>
</div>
<p>For a tumor 15 cm in diameter, the median age is about 22 years, the 90% credible interval is between 13 and 34 years, and the probability that it formed less than 9 years ago is less than 1%.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">-</span> <span class="n">cdf</span><span class="p">(</span><span class="mf">9.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9900990099009901
</pre></div>
</div>
</div>
</div>
<p>But this result is based on two modeling decisions that are potentially problematic:</p>
<ul class="simple">
<li><p>In the simulations, growth rate during each interval is independent of previous growth rates. In reality it is plausible that tumors that have grown quickly in the past are likely to grow quickly in the future. In other words, there is probably a serial correlation in growth rate.</p></li>
<li><p>To convert from linear measure to volume, we assume that tumors are approximately spherical.</p></li>
</ul>
<p>In additional experiments, I implemented a simulation that chooses growth rates with serial correlation; the effect is that the fast-growing tumors grow faster and the slow-growing tumors grow slower.
Nevertheless, with moderate correlation (0.5), the probability that a 15 cm tumor is less than 9 years old is only about 1%.</p>
<p>The assumption that tumors are spherical is probably fine for tumors up to a few centimeters, but not for a tumor with linear dimensions 15.5 x 15 cm.
If, as seems likely, a tumor this size is relatively flat, it might have the same volume as a 6 cm sphere.
But even with this smaller volume and correlation 0.5, the probability that this tumor is less than 9 years old is about 5%.</p>
<p>So even taking into account modeling errors, it is unlikely that such a large tumor could have formed after my correspondent retired from military service.</p>
<p>The following figure shows the distribution of ages for tumors with diameters 4, 8, and 15 cm.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">diameter</span> <span class="ow">in</span> <span class="n">diameters</span><span class="p">:</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="n">interpolate_ages</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span>
    <span class="n">cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">diameter</span><span class="si">}</span><span class="s1"> cm&#39;</span><span class="p">)</span>
    
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Tumor age (years)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/df1b7e305f0bf055e7cb9eff94aa6e9b81aac9dc8f20186a88f92e867a20b50e.png" src="_images/df1b7e305f0bf055e7cb9eff94aa6e9b81aac9dc8f20186a88f92e867a20b50e.png" />
</div>
</details>
</div>
</section>
<section id="approximate-bayesian-calculation">
<h2>Approximate Bayesian Calculation<a class="headerlink" href="#approximate-bayesian-calculation" title="Permalink to this heading">#</a></h2>
<p>At this point you might wonder why this example is in a book about Bayesian statistics.
We never defined a prior distribution or did a Bayesian update.
Why not? Because we didn’t have to.</p>
<p>Instead, we used simulations to compute ages and sizes for a collection of hypothetical tumors.
Then, implicitly, we used the simulation results to form a joint distribution of age and size.
If we select a column from the joint distribution, we get a distribution of size conditioned on age.
If we select a row, we get a distribution of age conditioned on size.</p>
<p>So this example is like the ones we saw in &lt;&lt;_Probability&gt;&gt;: if you have all of the data, you don’t need Bayes’s theorem; you can compute probabilities by counting.</p>
<p>This example is a first step toward Approximate Bayesian Computation (ABC).
The next example is a second step.</p>
</section>
<section id="counting-cells">
<h2>Counting Cells<a class="headerlink" href="#counting-cells" title="Permalink to this heading">#</a></h2>
<p>This example comes from <a class="reference external" href="https://dataorigami.net/blogs/napkin-folding/bayesian-cell-counting">this blog post</a>, by Cameron Davidson-Pilon.
In it, he models the process biologists use to estimate the concentration of cells in a sample of liquid.
The example he presents is counting cells in a “yeast slurry”, which is a mixture of yeast and water used in brewing beer.</p>
<p>There are two steps in the process:</p>
<ul class="simple">
<li><p>First, the slurry is diluted until the concentration is low enough that it is practical to count cells.</p></li>
<li><p>Then a small sample is put on a hemocytometer, which is a specialized microscope slide that holds a fixed amount of liquid on a rectangular grid.</p></li>
</ul>
<p>The cells and the grid are visible in a microscope, making it possible to count the cells accurately.</p>
<p>As an example, suppose we start with a yeast slurry with unknown concentration of cells.
Starting with a 1 mL sample, we dilute it by adding it to a shaker with 9 mL of water and mixing well.
Then we dilute it again, and then a third time.
Each dilution reduces the concentration by a factor of 10, so three dilutions reduces the concentration by a factor of 1000.</p>
<p>Then we add the diluted sample to the hemocytometer, which has a capacity of 0.0001 mL spread over a 5x5 grid.
Although the grid has 25 squares, it is standard practice to inspect only a few of them, say 5, and report the total number of cells in the inspected squares.</p>
<p>This process is simple enough, but at every stage there are sources of error:</p>
<ul class="simple">
<li><p>During the dilution process, liquids are measured using pipettes that introduce measurement error.</p></li>
<li><p>The amount of liquid in the hemocytometer might vary from the specification.</p></li>
<li><p>During each step of the sampling process, we might select more or less than the average number of cells, due to random variation.</p></li>
</ul>
<p>Davidson-Pilon presents a PyMC model that describes these errors.
I’ll start by replicating his model; then we’ll adapt it for ABC.</p>
<p>Suppose there are 25 squares in the grid, we count 5 of them, and the total number of cells is 49.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_squares</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">squares_counted</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">yeast_counted</span> <span class="o">=</span> <span class="mi">49</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the first part of the model, which defines the prior distribution of <code class="docutils literal notranslate"><span class="pre">yeast_conc</span></code>, which is the concentration of yeast we’re trying to estimate.</p>
<p><code class="docutils literal notranslate"><span class="pre">shaker1_vol</span></code> is the actual volume of water in the first shaker, which should be 9 mL, but might be higher or lower, with standard deviation 0.05 mL.
<code class="docutils literal notranslate"><span class="pre">shaker2_vol</span></code> and <code class="docutils literal notranslate"><span class="pre">shaker3_vol</span></code> are the volumes in the second and third shakers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="n">billion</span> <span class="o">=</span> <span class="mf">1e9</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">yeast_conc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;yeast conc&quot;</span><span class="p">,</span> 
                           <span class="n">mu</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">billion</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">billion</span><span class="p">)</span>

    <span class="n">shaker1_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;shaker1 vol&quot;</span><span class="p">,</span> 
                               <span class="n">mu</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">shaker2_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;shaker2 vol&quot;</span><span class="p">,</span> 
                               <span class="n">mu</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">shaker3_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;shaker3 vol&quot;</span><span class="p">,</span> 
                               <span class="n">mu</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, the sample drawn from the yeast slurry is supposed to be 1 mL, but might be more or less.
And similarly for the sample from the first shaker and from the second shaker.
The following variables model these steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">yeast_slurry_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;yeast slurry vol&quot;</span><span class="p">,</span>
                                    <span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">shaker1_to_shaker2_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;shaker1 to shaker2&quot;</span><span class="p">,</span>
                                    <span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">shaker2_to_shaker3_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;shaker2 to shaker3&quot;</span><span class="p">,</span>
                                    <span class="n">mu</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Given the actual volumes in the samples and in the shakers, we can compute the effective dilution, <code class="docutils literal notranslate"><span class="pre">final_dilution</span></code>, which should be 1000, but might be higher or lower.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">dilution_shaker1</span> <span class="o">=</span> <span class="p">(</span><span class="n">yeast_slurry_vol</span> <span class="o">/</span> 
                        <span class="p">(</span><span class="n">yeast_slurry_vol</span> <span class="o">+</span> <span class="n">shaker1_vol</span><span class="p">))</span>
    <span class="n">dilution_shaker2</span> <span class="o">=</span> <span class="p">(</span><span class="n">shaker1_to_shaker2_vol</span> <span class="o">/</span> 
                        <span class="p">(</span><span class="n">shaker1_to_shaker2_vol</span> <span class="o">+</span> <span class="n">shaker2_vol</span><span class="p">))</span>
    <span class="n">dilution_shaker3</span> <span class="o">=</span> <span class="p">(</span><span class="n">shaker2_to_shaker3_vol</span> <span class="o">/</span> 
                        <span class="p">(</span><span class="n">shaker2_to_shaker3_vol</span> <span class="o">+</span> <span class="n">shaker3_vol</span><span class="p">))</span>
    
    <span class="n">final_dilution</span> <span class="o">=</span> <span class="p">(</span><span class="n">dilution_shaker1</span> <span class="o">*</span> 
                      <span class="n">dilution_shaker2</span> <span class="o">*</span> 
                      <span class="n">dilution_shaker3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The next step is to place a sample from the third shaker in the chamber of the hemocytomer.
The capacity of the chamber should be 0.0001 mL, but might vary; to describe this variance, we’ll use a gamma distribution, which ensures that we don’t generate negative values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">chamber_vol</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s2">&quot;chamber_vol&quot;</span><span class="p">,</span> 
                           <span class="n">mu</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.0001</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>On average, the number of cells in the chamber is the product of the actual concentration, final dilution, and chamber volume.
But the actual number might vary; we’ll use a Poisson distribution to model this variance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">yeast_in_chamber</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s2">&quot;yeast in chamber&quot;</span><span class="p">,</span> 
        <span class="n">mu</span><span class="o">=</span><span class="n">yeast_conc</span> <span class="o">*</span> <span class="n">final_dilution</span> <span class="o">*</span> <span class="n">chamber_vol</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, each cell in the chamber will be in one of the squares we count with probability <code class="docutils literal notranslate"><span class="pre">p=squares_counted/total_squares</span></code>.
So the actual count follows a binomial distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> 
                        <span class="n">n</span><span class="o">=</span><span class="n">yeast_in_chamber</span><span class="p">,</span> 
                        <span class="n">p</span><span class="o">=</span><span class="n">squares_counted</span><span class="o">/</span><span class="n">total_squares</span><span class="p">,</span>
                        <span class="n">observed</span><span class="o">=</span><span class="n">yeast_counted</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With the model specified, we can use <code class="docutils literal notranslate"><span class="pre">sample</span></code> to generate a sample from the posterior distribution.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (2 chains in 2 jobs)
CompoundStep
&gt;NUTS: [chamber_vol, shaker2 to shaker3, shaker1 to shaker2, yeast slurry vol, shaker3 vol, shaker2 vol, shaker1 vol, yeast conc]
&gt;Metropolis: [yeast in chamber]
</pre></div>
</div>
<div class="output text_html">
    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [4000/4000 00:03<00:00 Sampling 2 chains, 0 divergences]
    </div>
    </div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_000 tune and 1_000 draw iterations (2_000 + 2_000 draws total) took 4 seconds.
The estimated number of effective samples is smaller than 200 for some parameters.
</pre></div>
</div>
</div>
</details>
</div>
<p>And we can use the sample to estimate the posterior distribution of <code class="docutils literal notranslate"><span class="pre">yeast_conc</span></code> and compute summary statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_sample</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;yeast conc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">billion</span>
<span class="n">cdf_pymc</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">posterior_sample</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cdf_pymc</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">cdf_pymc</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.2712488367301873 [1.8531491 2.7017654]
</pre></div>
</div>
</div>
</div>
<p>The posterior mean is about 2.3 billion cells per mL, with a 90% credible interval from 1.8 and 2.7.</p>
<p>So far we’ve been following in Davidson-Pilon’s footsteps.
And for this problem, the solution using MCMC is sufficient.
But it also provides an opportunity to demonstrate ABC.</p>
</section>
<section id="cell-counting-with-abc">
<h2>Cell Counting with ABC<a class="headerlink" href="#cell-counting-with-abc" title="Permalink to this heading">#</a></h2>
<p>The fundamental idea of ABC is that we use the prior distribution to generate a sample of the parameters, and then simulate the system for each set of parameters in the sample.</p>
<p>In this case, since we already have a PyMC model, we can use <code class="docutils literal notranslate"><span class="pre">sample_prior_predictive</span></code> to do the sampling and the simulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">prior_sample</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_prior_predictive</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The result is a dictionary that contains samples from the prior distribution of the parameters and the prior predictive distribution of <code class="docutils literal notranslate"><span class="pre">count</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">count</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>40.1144
</pre></div>
</div>
</div>
</div>
<p>Now, to generate a sample from the posterior distribution, we’ll select only the elements in the prior sample where the output of the simulation, <code class="docutils literal notranslate"><span class="pre">count</span></code>, matches the observed data, 49.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">49</span><span class="p">)</span>
<span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>221
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">mask</span></code> to select the values of <code class="docutils literal notranslate"><span class="pre">yeast_conc</span></code> for the simulations that yield the observed data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_sample2</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="s1">&#39;yeast conc&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">billion</span>
</pre></div>
</div>
</div>
</div>
<p>And we can use the posterior sample to estimate the CDF of the posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_abc</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">posterior_sample2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cdf_abc</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">cdf_abc</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.275872303142668 [1.87509925 2.72428803]
</pre></div>
</div>
</div>
</div>
<p>The posterior mean and credible interval are similar to what we got with MCMC.
Here’s what the distributions look like.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_pymc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;MCMC&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">cdf_abc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ABC&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Yeast concentration (cells/mL)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior distribution&#39;</span><span class="p">,</span>
         <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/8eaa208c16fc79c79edb3769816e14528e9b03eb810bc1d301ecdc95ce329632.png" src="_images/8eaa208c16fc79c79edb3769816e14528e9b03eb810bc1d301ecdc95ce329632.png" />
</div>
</div>
<p>The distributions are similar, but the results from ABC are noisier because the sample size is smaller.</p>
</section>
<section id="when-do-we-get-to-the-approximate-part">
<h2>When Do We Get to the Approximate Part?<a class="headerlink" href="#when-do-we-get-to-the-approximate-part" title="Permalink to this heading">#</a></h2>
<p>The examples so far are similar to Approximate Bayesian Computation, but neither of them demonstrates all of the elements of ABC.
More generally, ABC is characterized by:</p>
<ol class="arabic simple">
<li><p>A prior distribution of parameters.</p></li>
<li><p>A simulation of the system that generates the data.</p></li>
<li><p>A criterion for when we should accept that the output of the simulation matches the data.</p></li>
</ol>
<p>The kidney tumor example was atypical because we didn’t represent the prior distribution of age explicitly.
Because the simulations generate a joint distribution of age and size, we we able to get the marginal posterior distribution of age directly from the results.</p>
<p>The yeast example is more typical because we represented the distribution of the parameters explicitly.
But we accepted only simulations where the output matches the data exactly.</p>
<p>The result is approximate in the sense that we have a sample from the posterior distribution rather than the posterior distribution itself.
But it is not approximate in the sense of Approximate Bayesian Computation, which typically accepts simulations where the output matches the data only approximately.</p>
<p>To show how that works, I will extend the yeast example with an approximate matching criterion.</p>
<p>In the previous section, we accepted a simulation if the output is precisely 49 and rejected it otherwise.
As a result, we got only a few hundred samples out of 10,000 simulations, so that’s not very efficient.</p>
<p>We can make better use of the simulations if we give “partial credit” when the output is close to 49.
But how close?  And how much credit?</p>
<p>One way to answer that is to back up to the second-to-last step of the simulation, where we know the number of cells in the chamber, and we use the binomial distribution to generate the final count.</p>
<p>If there are <code class="docutils literal notranslate"><span class="pre">n</span></code> cells in the chamber, each has a probability <code class="docutils literal notranslate"><span class="pre">p</span></code> of being counted, depending on whether it falls in one of the squares in the grid that get counted.</p>
<p>We can extract <code class="docutils literal notranslate"><span class="pre">n</span></code> from the prior sample, like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="s1">&#39;yeast in chamber&#39;</span><span class="p">]</span>
<span class="n">n</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10000,)
</pre></div>
</div>
</div>
</div>
<p>And compute <code class="docutils literal notranslate"><span class="pre">p</span></code> like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">squares_counted</span><span class="o">/</span><span class="n">total_squares</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2
</pre></div>
</div>
</div>
</div>
<p>Now here’s the idea: we’ll use the binomial distribution to compute the likelihood of the data, <code class="docutils literal notranslate"><span class="pre">yeast_counted</span></code>, for each value of <code class="docutils literal notranslate"><span class="pre">n</span></code> and the fixed value of <code class="docutils literal notranslate"><span class="pre">p</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span>

<span class="n">likelihood</span> <span class="o">=</span> <span class="n">binom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">yeast_counted</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10000,)
</pre></div>
</div>
</div>
</details>
</div>
<p>When the expected count, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">*</span> <span class="pre">p</span></code>, is close to the actual count, <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> is relatively high; when it is farther away, <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> is lower.</p>
<p>The following is a scatter plot of these likelihoods versus the expected counts.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Expected count (number of cells)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Likelihood&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/b236c7fa22cca34323d3de3073ad4b52b044a670cfb4661663bb69c0e81373d7.png" src="_images/b236c7fa22cca34323d3de3073ad4b52b044a670cfb4661663bb69c0e81373d7.png" />
</div>
</div>
<p>We can’t use these likelihoods to do a Bayesian update because they are incomplete; that is, each likelihood is the probability of the data given <code class="docutils literal notranslate"><span class="pre">n</span></code>, which is the result of a single simulation.</p>
<p>But we <em>can</em> use them to weight the results of the simulations.
Instead of requiring the output of the simulation to match the data exactly, we’ll use the likelihoods to give partial credit when the output is close.</p>
<p>Here’s how: I’ll construct a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> that contains yeast concentrations as quantities and the likelihoods as unnormalized probabilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="s1">&#39;yeast conc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">billion</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">likelihood</span>
<span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this <code class="docutils literal notranslate"><span class="pre">Pmf</span></code>, values of <code class="docutils literal notranslate"><span class="pre">yeast_conc</span></code> that yield outputs close to the data map to higher probabilities.
If we sort the quantities and normalize the probabilities, the result is an estimate of the posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_pmf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">posterior_pmf</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">posterior_pmf</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.2723483584950497 [1.85449376 2.70563828]
</pre></div>
</div>
</div>
</div>
<p>The posterior mean and credible interval are similar to the values we got from MCMC.
And here’s what the posterior distributions look like.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_pymc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;MCMC&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="c1">#cdf_abc.plot(label=&#39;ABC&#39;)</span>
<span class="n">posterior_pmf</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ABC2&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Yeast concentration (cells/mL)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior distribution&#39;</span><span class="p">,</span>
         <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/49f8337976b730ce868462a4375483b9c032020dffdd39b08ca9b6e4e7958f12.png" src="_images/49f8337976b730ce868462a4375483b9c032020dffdd39b08ca9b6e4e7958f12.png" />
</div>
</div>
<p>The distributions are similar, but the results from MCMC are a little noisier.
In this example, ABC is more efficient than MCMC, requiring less computation to generate a better estimate of the posterior distribution.
But that’s unusual; usually ABC requires a lot of computation.
For that reason, it is generally a method of last resort.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p>In this chapter we saw two examples of Approximate Bayesian Computation (ABC), based on simulations of tumor growth and cell counting.</p>
<p>The definitive elements of ABC are:</p>
<ol class="arabic simple">
<li><p>A prior distribution of parameters.</p></li>
<li><p>A simulation of the system that generates the data.</p></li>
<li><p>A criterion for when we should accept that the output of the simulation matches the data.</p></li>
</ol>
<p>ABC is particularly useful when the system is too complex to model with tools like PyMC.
For example, it might involve a physical simulation based on differential equations.
In that case, each simulation might require substantial computation, and many simulations might be needed to estimate the posterior distribution.</p>
<p>Next, you’ll have a chance to practice with one more example.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<p><strong>Exercise:</strong> This exercise is based on <a class="reference external" href="http://www.sumsar.net/blog/2014/10/tiny-data-and-the-socks-of-karl-broman">a blog post by Rasmus Bååth</a>, which is motivated by a tweet from Karl Broman, who wrote:</p>
<blockquote>
<div><p>That the first 11 socks in the laundry are distinct suggests that there are a lot of socks.</p>
</div></blockquote>
<p>Suppose you pull 11 socks out of the laundry and find that no two of them make a matched pair.  Estimate the number of socks in the laundry.</p>
<p>To solve this problem, we’ll use the model Bååth suggests, which is based on these assumptions:</p>
<ul class="simple">
<li><p>The laundry contains some number of pairs of socks, <code class="docutils literal notranslate"><span class="pre">n_pairs</span></code>, plus some number of odd (unpaired) socks, <code class="docutils literal notranslate"><span class="pre">n_odds</span></code>.</p></li>
<li><p>The pairs of socks are different from each other and different from the unpaired socks; in other words, the number of socks of each type is either 1 or 2, never more.</p></li>
</ul>
<p>We’ll use the prior distributions Bååth suggests, which are:</p>
<ul class="simple">
<li><p>The number of socks follows a negative binomial distribution with mean 30 and standard deviation 15.</p></li>
<li><p>The proportion of socks that are paired follows a beta distribution with parameters <code class="docutils literal notranslate"><span class="pre">alpha=15</span></code> and <code class="docutils literal notranslate"><span class="pre">beta=2</span></code>.</p></li>
</ul>
<p>In the notebook for this chapter, I’ll define these priors.  Then you can simulate the sampling process and use ABC to estimate the posterior distributions.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">n_pairs</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">n_odds</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">socks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">),</span> 
                  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_pairs</span> <span class="o">+</span> <span class="n">n_odds</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">socks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0  1  2  3  4  5  6  7  8  0  1  2  3  4  5  6  7  8  9 10 11 12 13]
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">picked_socks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">socks</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">picked_socks</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 6,  5,  8,  7,  1,  0,  8,  5, 10, 12,  6])
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">picked_socks</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0,  1,  5,  6,  7,  8, 10, 12])
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">counts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1, 1, 2, 2, 1, 2, 1, 1])
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">solo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>

<span class="n">solo</span><span class="p">,</span> <span class="n">pairs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5, 3)
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="k">def</span> <span class="nf">pick_socks</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">n_odds</span><span class="p">,</span> <span class="n">n_pick</span><span class="p">):</span>
    <span class="n">socks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">),</span> 
                      <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_pairs</span> <span class="o">+</span> <span class="n">n_odds</span><span class="p">))</span>
    
    <span class="n">picked_socks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">socks</span><span class="p">,</span> 
                                    <span class="n">size</span><span class="o">=</span><span class="n">n_pick</span><span class="p">,</span> 
                                    <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">picked_socks</span><span class="p">,</span> 
                               <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">odds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">odds</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">pick_socks</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">n_odds</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 7)
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">n_socks</span> <span class="o">=</span> <span class="n">prior_n_socks</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_socks</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">prop_pairs</span> <span class="o">=</span> <span class="n">prior_prop_pair</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
    <span class="n">n_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n_socks</span><span class="o">//</span><span class="mi">2</span> <span class="o">*</span> <span class="n">prop_pairs</span><span class="p">)</span>
    <span class="n">n_odds</span> <span class="o">=</span> <span class="n">n_socks</span> <span class="o">-</span> <span class="n">n_pairs</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pick_socks</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">n_odds</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n_socks</span><span class="p">,</span> <span class="n">n_pairs</span><span class="p">,</span> <span class="n">n_odds</span><span class="p">))</span>

<span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1156
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_socks&#39;</span><span class="p">,</span> <span class="s1">&#39;n_pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;n_odds&#39;</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_socks</th>
      <th>n_pairs</th>
      <th>n_odds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>52</td>
      <td>25.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>54</td>
      <td>26.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>41</td>
      <td>18.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>35</td>
      <td>14.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>57</td>
      <td>19.0</td>
      <td>19.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">posterior_n_socks</span> <span class="o">=</span> <span class="n">Pmf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_socks&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">posterior_n_socks</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
      <span class="n">posterior_n_socks</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>44.0 [27. 74.]
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_n_socks</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;posterior&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Number of socks&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PMF&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c50294d3bdbfeea2193671a474d85658c75f9e858b4eefdea006ede9e1f375b7.png" src="_images/c50294d3bdbfeea2193671a474d85658c75f9e858b4eefdea006ede9e1f375b7.png" />
</div>
</details>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="chap19.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">MCMC</p>
      </div>
    </a>
    <a class="right-next"
       href="redline.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">The Red Line Problem</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-kidney-tumor-problem">The Kidney Tumor Problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-growth-model">A Simple Growth Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-more-general-model">A More General Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approximate-bayesian-calculation">Approximate Bayesian Calculation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#counting-cells">Counting Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cell-counting-with-abc">Cell Counting with ABC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-do-we-get-to-the-approximate-part">When Do We Get to the Approximate Part?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>